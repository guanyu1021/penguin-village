<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†è€… - æ²™ç›¤æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        .grid-cell { width: 22px; height: 22px; border: 0.1px solid #444; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; }
        .cell-base { background-color: #ef4444; color: white; border: 2px solid #b91c1c; }
        .cell-stone { background-color: #475569; color: white; border: 2px solid #1e293b; font-size: 14px; }
        .cell-item { background-color: #facc15; border: 1px solid #ca8a04; color: #854d0e; }
        .sidebar { height: 100vh; overflow-y: auto; background-color: #1e293b; color: white; }
        #game-map { display: grid; grid-template-columns: repeat(32, 22px); background-color: #334155; padding: 4px; gap: 1px; }
        .preview-valid { background-color: rgba(34, 197, 94, 0.6) !important; }
        .preview-invalid { background-color: rgba(239, 68, 68, 0.6) !important; }
    </style>
</head>
<body class="bg-slate-900 flex">
    <div class="w-80 p-4 sidebar flex flex-col gap-4">
        <h1 class="text-xl font-bold text-red-400 border-b border-slate-600 pb-2">ç®¡ç†è€…æ“ä½œ</h1>
        
        <label class="text-sm text-slate-400">ç•¶å‰æ“ä½œå°åˆ†éšŠï¼š</label>
        <select id="team-select" onchange="currentTeamIdx = this.value" class="w-full p-2 bg-slate-700 rounded text-white"></select>
        
        <div class="grid grid-cols-3 gap-1">
            <button onclick="currentMode='place'" class="py-2 bg-blue-600 rounded text-xs font-bold">æ”¾ç½®æ¨¡å¼</button>
            <button onclick="currentMode='stone'" class="py-2 bg-slate-600 rounded text-xs font-bold">çŸ³é ­æ¨¡å¼</button>
            <button onclick="currentMode='remove'" class="py-2 bg-red-800 rounded text-xs font-bold">ç§»é™¤æ¨¡å¼</button>
        </div>

        <div id="tile-palette" class="grid grid-cols-4 gap-2 border-t border-slate-700 pt-4"></div>
        
        <div id="score-board" class="mt-4 space-y-1 text-xs"></div>
        
        <button onclick="resetGame()" class="mt-auto py-2 bg-red-600 rounded font-bold">âš ï¸ é‡ç½®å…¨å ´è³‡æ–™</button>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center p-4">
        <div id="game-map"></div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl text-center">
            <h2 class="text-3xl font-bold mb-4">ğŸ ç²å¾—é“å…·ï¼</h2>
            <p id="modal-text" class="text-xl mb-6"></p>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="px-6 py-2 bg-blue-600 text-white rounded-lg">ç¢ºèª</button>
        </div>
    </div>

    <script>
        // === âš ï¸ è«‹åœ¨æ­¤å¡«å…¥ä½ çš„ FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyBBufDrt_ReM-5qLeQyJs2nXAwdMO_TbC4",
            authDomain: "sunflower-b5be6.firebaseapp.com",
            projectId: "sunflower-b5be6",
            storageBucket: "sunflower-b5be6.firebasestorage.app",
            messagingSenderId: "206261082118",
            appId: "1:206261082118:web:77e158bd61b287056a8b87",
            measurementId: "G-T477KW8R2L"
        };
        // =========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const GRID_SIZE = 32;
        const TILE_DEFS = { 1: [[0,0]], 2: [[0,0],[0,1]], 3: [[0,0],[0,1],[1,1]], 4: [[0,0],[0,1],[0,2]], 5: [[0,0],[0,1],[0,2],[1,2]], 6: [[0,0],[0,1],[0,2],[0,3]] };
        const BASE_LOCS = [{r:4, c:4}, {r:4, c:12}, {r:4, c:21}, {r:4, c:29}, {r:12, c:4}, {r:12, c:12}, {r:12, c:21}, {r:12, c:29}, {r:21, c:4}, {r:21, c:12}, {r:21, c:21}, {r:21, c:29}, {r:29, c:4}, {r:29, c:12}, {r:29, c:21}, {r:29, c:29}];
        const ITEM_LOCS = [{r:8, c:16, name:"åŠ åˆ†å¡"}, {r:16, c:8, name:"é›™å€å¡"}, {r:16, c:25, name:"åŠ åˆ†å¡"}];
        const COLORS = ['#F87171','#FB923C','#FBBF24','#34D399','#22D3EE','#60A5FA','#818CF8','#A78BFA','#C084FC','#F472B6','#94A3B8','#4ADE80','#A3E635','#FACC15','#2DD4BF','#FB7185'];

        let mapData = Array(GRID_SIZE+1).fill().map(() => Array(GRID_SIZE+1).fill(null));
        let teamInfo = [];
        let currentTeamIdx = 0;
        let currentMode = 'place';
        let currentShape = TILE_DEFS[1];

        function init() {
            // åˆå§‹åŒ–éšŠä¼
            const select = document.getElementById('team-select');
            for(let i=0; i<16; i++) {
                const id = `${Math.floor(i/2)+1}${i%2===0?'A':'B'}`;
                teamInfo.push({ id, color: COLORS[i], score: 0, baseSelected: false, baseCoord: null });
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = `ç¬¬ ${id} å°éšŠ`;
                select.appendChild(opt);
            }

            // ç¹ªè£½åœ°åœ–
            const mapEl = document.getElementById('game-map');
            for(let r=1; r<=GRID_SIZE; r++) {
                for(let c=1; c<=GRID_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.id = `cell-${r}-${c}`;
                    cell.onclick = () => handleClick(r, c);
                    cell.onmouseenter = () => handlePreview(r, c);
                    mapEl.appendChild(cell);
                }
            }

            // èª¿è‰²ç›¤
            const palette = document.getElementById('tile-palette');
            Object.keys(TILE_DEFS).forEach(k => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-700 p-1 rounded text-[10px]";
                btn.textContent = `å½¢ç‹€ ${k}`;
                btn.onclick = () => { currentShape = TILE_DEFS[k]; currentMode = 'place'; };
                palette.appendChild(btn);
            });

            // ç›£è½é›²ç«¯è³‡æ–™
            db.ref('gameData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    mapData = data.mapData;
                    teamInfo = data.teamInfo;
                    renderMap();
                    renderScores();
                }
            });
        }

        function sync() {
            db.ref('gameData').set({ mapData, teamInfo });
        }

        function handleClick(r, c) {
            const team = teamInfo[currentTeamIdx];
            if(currentMode === 'stone') {
                mapData[r][c] = { type: 'stone' };
            } else if(currentMode === 'remove') {
                mapData[r][c] = null;
            } else {
                if(!team.baseSelected) {
                    if(BASE_LOCS.find(b => b.r === r && b.c === c)) {
                        team.baseSelected = true; team.baseCoord = {r,c};
                        mapData[r][c] = { teamId: team.id };
                    }
                } else {
                    const coords = currentShape.map(p => ({r: r+p[0], c: c+p[1]}));
                    if(canPlace(coords, team.id)) {
                        coords.forEach(p => {
                            mapData[p.r][p.c] = { teamId: team.id };
                            const item = ITEM_LOCS.find(it => it.r === p.r && it.c === p.c);
                            if(item) {
                                document.getElementById('modal-text').textContent = `${team.id} å°éšŠç²å¾—äº† ${item.name}ï¼`;
                                document.getElementById('modal').classList.remove('hidden');
                            }
                        });
                        team.score += coords.length;
                    }
                }
            }
            sync();
        }

        function canPlace(coords, teamId) {
            let hasAdj = false;
            for(let p of coords) {
                if(p.r<1 || p.r>GRID_SIZE || p.c<1 || p.c>GRID_SIZE) return false;
                if(mapData[p.r][p.c] !== null) return false;
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                    const nr = p.r+dr, nc = p.c+dc;
                    if(nr>=1 && nr<=GRID_SIZE && nc>=1 && nc<=GRID_SIZE && mapData[nr][nc]?.teamId === teamId) hasAdj = true;
                });
            }
            return hasAdj;
        }

        function renderMap() {
            for(let r=1; r<=GRID_SIZE; r++) {
                for(let c=1; c<=GRID_SIZE; c++) {
                    const el = document.getElementById(`cell-${r}-${c}`);
                    const cell = mapData[r][c];
                    el.className = 'grid-cell'; el.style.backgroundColor = ""; el.textContent = "";
                    if(cell) {
                        if(cell.type === 'stone') { el.classList.add('cell-stone'); el.textContent = "ğŸª¨"; }
                        else {
                            const t = teamInfo.find(ti => ti.id === cell.teamId);
                            el.style.backgroundColor = t.color;
                            if(t.baseCoord?.r === r && t.baseCoord?.c === c) el.textContent = t.id;
                        }
                    } else if(BASE_LOCS.find(b => b.r === r && b.c === c)) {
                        el.classList.add('cell-base');
                    } else if(ITEM_LOCS.find(it => it.r === r && it.c === c)) {
                        el.classList.add('cell-item'); el.textContent = "ğŸ";
                    }
                }
            }
        }

        function renderScores() {
            const board = document.getElementById('score-board');
            board.innerHTML = teamInfo.map(t => `<div class="flex justify-between p-1 bg-slate-800 rounded"><span>${t.id}</span><span>${t.score}åˆ†</span></div>`).join('');
        }

        function resetGame() { if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰é€²åº¦ï¼Ÿ")) db.ref('gameData').set(null); }
        init();
    </script>
</body>
</html>
