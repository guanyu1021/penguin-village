<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ²™ç›¤å¯¦æ³ç›´æ’­ - V8.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        .grid-cell { width: 22px; height: 22px; border: 0.1px solid #444; font-size: 10px; display: flex; align-items: center; justify-content: center; }
        .cell-stone { background-color: #475569; color: white; border: 2px solid #1e293b; font-size: 14px; }
        .cell-item { background-color: #facc15; border: 1px solid #ca8a04; color: #854d0e; }
        #game-map { display: grid; grid-template-columns: repeat(32, 22px); background-color: #334155; padding: 4px; gap: 1px; }
        .sidebar { height: 100vh; overflow-y: auto; background-color: #0f172a; color: white; }
    </style>
</head>
<body class="bg-slate-900 flex">
    <div class="w-72 p-4 sidebar flex flex-col gap-4 shadow-2xl">
        <h1 class="text-xl font-bold text-yellow-500 border-b border-slate-700 pb-2 text-center">ğŸ† å³æ™‚æ’è¡Œæ¦œ</h1>
        <div id="score-board" class="text-sm space-y-2"></div>
    </div>

    <div class="flex-1 flex flex-col items-center justify-center p-6">
        <div id="status-display" class="mb-6 px-10 py-3 rounded-full bg-blue-900 text-white font-bold text-2xl shadow-xl border-2 border-blue-400">
            ä¼éµæ‘å¾æœæˆ° - å¯¦æ³è½‰æ’­ä¸­
        </div>
        <div class="bg-slate-700 p-2 rounded shadow-2xl scale-110 mt-4">
            <div id="game-map"></div>
        </div>
    </div>

    <script>
        // --- å¿…é ˆèˆ‡ Admin ç‰ˆç›¸åŒçš„ Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyBBufDrt_ReM-5qLeQyJs2nXAwdMO_TbC4",
            authDomain: "sunflower-b5be6.firebaseapp.com",
            databaseURL: "https://sunflower-b5be6-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sunflower-b5be6",
            storageBucket: "sunflower-b5be6.firebasestorage.app",
            messagingSenderId: "206261082118",
            appId: "1:206261082118:web:77e158bd61b287056a8b87",
            measurementId: "G-T477KW8R2L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function initViewer() {
            const mapEl = document.getElementById('game-map');
            for(let r=1; r<=32; r++) {
                for(let c=1; c<=32; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.id = `v-${r}-${c}`;
                    mapEl.appendChild(cell);
                }
            }

            db.ref('gameData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    renderMap(data);
                    renderScores(data.teamInfo);
                }
            });
        }

        function renderMap(data) {
            const { mapData, teamInfo, deadItems } = data;
            const deadSet = new Set(deadItems || []);
            for(let r=1; r<=32; r++) {
                for(let c=1; c<=32; c++) {
                    const el = document.getElementById(`v-${r}-${c}`);
                    const cell = mapData[r][c];
                    el.className = 'grid-cell'; el.style = ""; el.textContent = "";
                    if(cell) {
                        if(cell.type === 'stone') { el.classList.add('cell-stone'); el.textContent = "ğŸª¨"; }
                        else {
                            const t = teamInfo.find(ti => ti.id === cell.teamId);
                            el.style.backgroundColor = t.color;
                            if(t.baseCoord?.r === r && t.baseCoord?.c === c) el.textContent = t.id;
                        }
                    } else if(deadSet.has(`${r},${c}`)) {
                        el.style.backgroundColor = "#334155";
                    }
                }
            }
        }

        function renderScores(teams) {
            const board = document.getElementById('score-board');
            const sorted = [...teams].sort((a,b) => b.score - a.score);
            board.innerHTML = sorted.map((t, i) => `
                <div class="p-3 bg-slate-800 rounded border-l-4" style="border-color:${t.color}">
                    <div class="flex justify-between font-bold">
                        <span>${i+1}. ${t.id}</span> <span>${t.score} åˆ†</span>
                    </div>
                </div>
            `).join('');
        }

        initViewer();
    </script>
</body>
</html>
